---
title: "Exploring Industries"
author: "Elena Tartaglia"
date: "15 August 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(RColorBrewer)
OUTPUT_FILEPATH = here::here("output")
```

*Challenge: How can we help identify and assist people in industries most affected by COVID-19?*

## Read data

```{r}
table4 = readxl::read_excel(here::here("data", "6291004.xls"),
                            sheet = "Data1",
                            col_names = TRUE,
                            skip = 9)
# take every third column because that contains original counts
table4 = table4[, seq(1, ncol(table4), 3)]
names(table4)[names(table4) == "Series ID"] = "Quarter"
# create a Year column
table4 = table4 %>%
  mutate(
    Year = substr(Quarter, 1, 4),
    Quarter2 = substr(Quarter, 6, 11)
  )
# create long version of data
table4_long = table4 %>%
  gather(key = "Industry", value = "Employment", -c(Quarter, Quarter2, Year))
```

Make a table of industry names 

```{r}
industry_names = readxl::read_excel(here::here("data", "6291004.xls"),
                            sheet = "Data1",
                            col_names = paste0("C", 1:61),
                            n_max = 10)
industry_names = industry_names[, seq(1, ncol(industry_names), 3)]
colnames(industry_names) = industry_names[10, ]

industry_names = lapply(industry_names[1, ], function(x) sub("\\s+$", "", stringr::str_extract(x, "[^;]*")))
```

Read in industry codes

```{r}
industry_codes = read.csv(here::here("data", "broad_avg_taxable_income.csv"))
industry_codes = industry_codes[, c("broad_code", "broad_name")]
```

```{r}
table4_long$broad_name=unlist(industry_names[table4_long$Industry], use.names = FALSE)
```

Add industry codes to long table.

```{r}
table4_long = table4_long %>%
  full_join(industry_codes, by = "broad_name")
```


### Table for raw employment figures plots per industry

```{r}
employment_since_2018 = table4_long %>%
  filter(Quarter > as.POSIXct("2018-02-01")) %>%
  filter(Industry != "A84932399X")
write.csv(employment_since_2018,
          file.path(OUTPUT_FILEPATH,"broad_employment_since_2018.csv"))
```


```{r}
employment_since_2010 = table4_long %>%
  filter(Quarter > as.POSIXct("2010-02-01")) %>%
  filter(Industry != "A84932399X") # remove total
write.csv(employment_since_2010,
          file.path(OUTPUT_FILEPATH,"broad_employment_since_2010.csv"))
```


## Plots

Colour palette

```{r}
colourCount = length(unique(table4_long$Industry))
getPalette = colorRampPalette(brewer.pal(9, "Set1"))
```



Plot the employment rates



```{r}
table4 %>%
  filter(Quarter > as.POSIXct("2018-02-01")) %>%
  ggplot(aes(x = Quarter, y = A84932399X)) +
  geom_point()+
  geom_line() +
  labs(title = industry_names["A84932399X"])
```




```{r}
table4_long %>%
  filter(Quarter > as.POSIXct("2018-02-01")) %>%
  filter(Industry != "A84932399X") %>%
  ggplot(aes(x = Quarter, y = Employment, colour = Industry)) +
  geom_point()+
  geom_line()+
  scale_color_manual(values = getPalette(colourCount), labels = industry_names)
```

Can see "Accommodation and Food Services" have taken a big hit.

```{r}
table4 %>%
  filter(Quarter > as.POSIXct("2018-02-01")) %>%
  ggplot(aes(x = Quarter, y = A84090248T)) +
  geom_point()+
  geom_line() +
  labs(title = industry_names["A84090248T"], y = "Number Employed (1000 people)")+
  scale_x_continuous(breaks = unique(table4$Quarter))+
  theme(axis.text.x = element_text(angle=20)) 
```




```{r}
ggplot(employment_since_2018, aes(x = Quarter, y = Employment, color = broad_name)) +
  geom_point()+
  geom_line() +
  labs(y = "Number Employed (1000 people)")+
  facet_wrap(.~broad_name) +
  scale_x_continuous(breaks = unique(employment_since_2018$Quarter))+
  theme(axis.text.x = element_text(angle=20)) 
```


```{r}
table4 %>%
  filter(Quarter > as.POSIXct("2010-02-01")) %>%
  ggplot(aes(x = Quarter2, y = A84090248T, colour = factor(Year), group = factor(Year))) +
  geom_point()+
  geom_line() +
  labs(title = industry_names["A84090248T"])
```


```{r}
table4 %>%
  filter(Quarter > as.POSIXct("2010-02-01")) %>%
  ggplot(aes(x = Quarter2, y = A84090249V, colour = factor(Year), group = factor(Year))) +
  geom_point()+
  geom_line() +
  labs(title = industry_names["A84090249V"])
```

```{r}
table4_long %>%
  filter(Quarter > as.POSIXct("2010-02-01")) %>%
  filter(Industry != "A84932399X") %>% # remove total %>%
  ggplot(aes(x = Quarter2, y = Employment, group = factor(Year))) +
  geom_point(color="grey") +
  geom_line(color="grey") +
  geom_line(data=subset(table4_long, Year == "2020" & Industry != "A84932399X"), colour="red") +
  geom_point(data=subset(table4_long, Year == "2020" & Industry != "A84932399X"), colour="red") +
  #labs(title = industry_names[Industry]) +
  facet_wrap(.~Industry,
             scales = "free_y")
```

```{r}
cutdown_t4 = table4_long %>%
  filter(Quarter > as.POSIXct("2010-02-01")) %>%
  filter(Industry != "A84932399X") # remove total
cutdown_t4$Industry = as.factor(cutdown_t4$Industry)
levels(cutdown_t4$Industry) = unlist(industry_names[levels(cutdown_t4$Industry)], use.names=FALSE)

  ggplot(cutdown_t4, aes(x = Quarter2, y = Employment, group = factor(Year))) +
  geom_point(color="grey") +
  geom_line(color="grey") +
  geom_line(data=subset(cutdown_t4, Year == "2020"), colour="red") +
  geom_point(data=subset(cutdown_t4, Year == "2020"), colour="red") +
  #labs(title = industry_names[Industry]) +
  facet_wrap(.~Industry,
             scales = "free_y")
```


```{r}
ggplot(employment_since_2010, aes(x = Quarter2, y = Employment, group = factor(Year))) +
  geom_point(color="grey") +
  geom_line(color="grey") +
  geom_line(data=subset(employment_since_2010, Year == "2020"), colour="red") +
  geom_point(data=subset(employment_since_2010, Year == "2020"), colour="red") +
  #labs(title = industry_names[Industry]) +
  facet_wrap(.~broad_name,
             scales = "free_y")
```


TODO

1. Create a table for each visualisation (with variable names according to Marc's format)

1. Write a sentence about each graph (to read for the video)
